# Книжная витрина

## Описание проекта

Данный сервис предоставляет API для управления авторами и книгами. Все данные хранятся в базе данных, а ответы API
возвращаются в формате JSON.

**Для запуска используйте скрипт `up.sh`**


## Ход работы

### 1. Создание моделей и соответствующих таблиц

- **Модель Author**  
  Поля:
    - `id`: уникальный идентификатор автора
    - `name`: имя автора
    - `information`: информация об авторе
    - `birthday`: дата рождения автора

  Отношение:
    - `HasMany`: метод `books` для получения книг, связанных с этим автором.

- **Модель Book**  
  Поля:
    - `id`: уникальный идентификатор книги
    - `author_id`: идентификатор автора (внешний ключ)
    - `name`: название книги
    - `annotation`: аннотация книги
    - `published_at`: дата публикации книги

  Отношения:
    - `belongsTo`: метод `author` для получения автора этой книги.
    - `HasMany`: метод `chapters` для получения глав, связанных с этой книгой.

- **Модель Chapter**  
  Поля:
    - `id`: уникальный идентификатор главы
    - `book_id`: идентификатор книги (внешний ключ)
    - `name`: название главы
    - `content`: текст главы

  Отношение:
    - `belongsTo`: метод `book` для получения книги, к которой принадлежит глава.

### 2. Создание маршрутов

**Важно:** Ответ выдается в ресурсе или в коллекции ресурсов. Были учтены различные варианты получения данных.

#### Для автора
- **AuthorResource**: содержит только информацию о пользователе.
- **AuthorWithBooksResource**: содержит информацию о пользователе и список его книг.

#### Для книг
- **BookCreateResource**: информация о книге (используется при создании книги).
- **BookResource**: информация о книге.
- **BookWithAuthorResource**: информация о книге вместе с информацией о её авторе.
- **BookWithChaptersResource**: информация о книге вместе со списком её глав.
- **BookFullResource**: информация о книге вместе с автором и главами.

#### Для глав
- **ChapterCreateResource**: информация о главе (используется при создании главы).
- **ChapterUpdateResource**: информация о главе (используется при обновлении главы).



### Автор

#### 1. Получение списка авторов

- **Маршрут**: `GET /authors`
- **Описание**: Получение списка всех авторов с пагинацией.

#### 2. Получение информации об авторе

- **Маршрут**: `GET /author/{author}`
- **Описание**: Получение информации об одном авторе.

#### 3. Создание нового автора

- **Маршрут**: `POST /author/create`
- **Описание**: Создание нового автора.
  ```json
  {
  "name": "Maxim",
  "information": "Hello guys",
  }

#### 4. Обновление информации об авторе

- **Маршрут**: `PUT /author/update/{author}`
- **Описание**: Обновление информации об авторе.
  ```json
  {
  "name": "Artem",
  "information": "Hello guys",
  }

### Книга

#### 5. Создание новой книги

- **Маршрут**: `POST /book/create`
- **Описание**: Создание новой книги. Необходимые поля для создания: `author_id`, `name`, `published_at`.
  ```json
  {
    "author_id": 1,
    "name": "The first name",
    "published_at": "03-03-2020"
  }

#### 6. Обновление информации о книге

- **Маршрут**: `PUT /book/update`
- **Контроллер**: `BookController::bookUpdate`
- **Описание**: Обновление информации о книге. Необходимые поля для
  обновления: `id`, `author_id`, `name`, `annotation`, `published_at`.
  ```json
  {
    "author_id": 1,
    "name": "The second name",
    "published_at": "03-03-2022"
  }

#### 7. Получение списка всех книг

- **Маршрут**: `GET /books`
- **Описание**: Получение списка всех книг с пагинацией.

#### 8. Получение информации о книге

- **Маршрут**: `GET /book/{book}`
- **Описание**: Получение информации о книге по ее идентификатору.

### Глава

#### 9. Создание новой главы

- **Маршрут**: `POST /chapter/create`
- **Описание**: Создание новой главы. Необходимые поля для создания: `book_id`, `name`, `content`.
  ```json
  {
    "book_id": 1,
    "name": "Some name",
    "content": "Some info"
  }

#### 10. Обновление информации о главе

- **Маршрут**: `PUT /chapter/update/{chapter}`
- **Контроллер**: `ChapterController::chapterUpdate`
- **Описание**: Обновление информации о главе. Необходимые поля для обновления: `book_id`, `name`, `content`.
  ```json
  {
    "book_id": 1,
    "name": "Some name number 2",
    "content": "Some info number 2"
  }

### 3. Валидация входных данных

Валидация входных параметров осуществляется с помощью создания и использования **Form Request**. Были разработаны кастомные валидационные механизмы для соответствующих запросов и данных.

**Важно:** Если вы будете проверять через Postman, в заголовок `Accept` введите `application/json` для получения сообщения об ошибке при вводе некорректных данных.

Помимо стандартной проверки данных, было создано правило для случаев, когда книга опубликована:
- раньше даты рождения автора
- в будущем;

### 4. Пагинация

Настройка и осуществление пагинации была выполнена с помощью дополнительного пакета **spatie**.

- Максимальное количество авторов на странице — 15.
- Максимальное количество книг на странице — 10.

Для изменения страниц необходимо изменять число в URL:

- Для авторов:
  - `api/authors?page=1`
  - `api/authors?page=2`

- Для книг:
  - `api/books?page=1`
  - `api/books?page=2`

Кроме того, количество книг авторов вычисляется динамически, и сортировка осуществляется по этому критерию (от большего к меньшему).

### 5. Дополнительное условие 1

Была создана модель, таблицы и соответствующие методы. При добавлении или изменении глав - происходит переопределение общего количества страниц соответствующей книги.

### 6. Дополнительное условие 2

Добавлен метод в модель Book, который получает глав, принадлежащие конкретной книге

### 7. Дополнительное условие 3 - Тесты

Были созданы три файла с тестами в папке `Feature`:
- **AuthorTest**: тесты для функциональности работы с авторами.
- **BookTest**: тесты для функциональности работы с книгами.
- **ChapterTest**: тесты для функциональности работы с главами.
  Для запуска тестов выполните следующую команду в терминале:

  ```bash
  docker-compose run --rm artisan test

#### Тесты для автора

#### 1. Создание корректного автора
- **Метод**: `testCreateValidAuthor`
- **Описание**: Проверяет, что можно создать автора с корректными данными.
- **Ожидаемый результат**:
  - Статус ответа: `201 Created`
  - Данные автора должны быть сохранены в базе данных.

#### 2. Создание некорректного автора
- **Метод**: `testCreateInvalidAuthor`
- **Описание**: Проверяет, что создание автора с некорректными данными (имя менее 2 символов) возвращает ошибку валидации.
- **Ожидаемый результат**:
  - Статус ответа: `422 Unprocessable Entity`
  - Ошибка валидации должна содержать ключ `name`.

#### 3. Обновление автора
- **Метод**: `testUpdateAuthor`
- **Описание**: Проверяет возможность обновления информации об авторе.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Данные автора должны быть обновлены в базе данных.

#### 4. Проверка пагинированного списка авторов
- **Метод**: `testCheckPaginatedAuthorList`
- **Описание**: Проверяет, что при запросе списка авторов возвращается не более 15 авторов на страницу.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Количество авторов в ответе должно быть равно 15.

#### 5. Проверка получения автора с книгами
- **Метод**: `testCheckGettingAuthorWithBooks`
- **Описание**: Проверяет, что при запросе информации об авторе возвращается информация о количестве книг и список книг.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Ответ должен содержать структуру с `id`, `name`, `books_count` и `books`.


#### Тесты для книг


#### 1. Создание книги
- **Метод**: `testCreateBook`
- **Описание**: Проверяет, что можно создать книгу с корректными данными.
- **Ожидаемый результат**:
  - Статус ответа: `201 Created`
  - Данные книги должны быть сохранены в базе данных.
  - 
#### 2. Обновление книги
- **Метод**: `testUpdateBook`
- **Описание**: Проверяет, что можно обновить книгу с корректными данными
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Обновленные данные книги должны быть сохранены в базе данных.

#### 3. Проверка обязательных полей при создании книги
- **Метод**: `testCheckValidateRequiredFieldOfBookCreating`
- **Описание**: Проверяет, что при создании книги без обязательных полей возвращается ошибка валидации.
- **Ожидаемый результат**:
  - Статус ответа: `422 Unprocessable Entity`
  - Ошибка валидации должна содержать ключ `name`.

#### 4. Проверка пагинации книг
- **Метод**: `testBookPagination`
- **Описание**: Проверяет, что при запросе списка книг возвращается не более 10 книг на страницу.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Количество книг в ответе должно быть равно 10.

#### 5. Проверка получения книги с автором
- **Метод**: `testBookWithAuthor`
- **Описание**: Проверяет, что при запросе информации о книге возвращается информация о ее авторе.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Ответ должен содержать структуру с `name`, `total_characters` и данными о `author`.

#### 6. Проверка формата даты при создании книги
- **Метод**: `testCheckInvalidDateFormat`
- **Описание**: Проверяет, что при создании книги с некорректным форматом даты возвращается ошибка валидации.
- **Ожидаемый результат**:
  - Статус ответа: `422 Unprocessable Entity`
  - Ошибка валидации должна содержать ключ `published_at`.

#### 7. Проверка получения книги с главами
- **Метод**: `testGetBookWithChapters`
- **Описание**: Проверяет, что при запросе информации о книге возвращается информация о ее главах.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Ответ должен содержать структуру с `name`, `total_characters` и массивом `chapters`.

#### 8. Проверка получения полной информации о книге
- **Метод**: `testGetBookFull`
- **Описание**: Проверяет, что при запросе полной информации о книге возвращается информация о ее авторе и главах.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Ответ должен содержать структуру с `name`, `total_characters`, `author` и массивом `chapters`.


#### Тесты для глав


#### 1. Создание главы
- **Метод**: `testCreateChapter`
- **Описание**: Проверяет, что можно создать главу с корректными данными.
- **Ожидаемый результат**:
  - Статус ответа: `201 Created`
  - Данные главы должны быть сохранены в базе данных.

#### 2. Обновление главы
- **Метод**: `testUpdateChapter`
- **Описание**: Проверяет, что можно обновить существующую главу с новыми данными.
- **Ожидаемый результат**:
  - Статус ответа: `200 OK`
  - Данные главы должны быть обновлены в базе данных с новыми значениями `name` и `content`.